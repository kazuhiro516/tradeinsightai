# 📈 FXトレード練習機能 要件定義書

## 概要

ユーザーがリスクなしでFXトレードの練習を行える機能を提供する。リアルタイムチャートを使用した仮想的なトレード環境で、実際の市場データに基づく練習取引を可能にする。

## 目的

- 初心者ユーザーのFXトレード学習支援
- リスクなしでの戦略テスト
- トレード技術の向上
- 取引記録の蓄積と分析

## 機能概要

### 1. チャート表示機能
- **ライブラリ**: lightweight-charts v5.0.8
- **チャートタイプ**: ローソク足チャート
- **対応通貨ペア**: USDJPY, EURJPY, GBPJPY, EURUSD, GBPUSD
- **対応時間足**: 1m, 5m, 15m, 30m, 1h, 4h, 1d
- **データ**: サンプルデータ（1000件のOHLCVデータ）

### 2. トレード実行機能
- **注文タイプ**: 買い注文、売り注文
- **ロット設定**: 0.01〜10.00（デフォルト: 0.1）
- **リスク管理**: ストップロス、テイクプロフィット設定
- **メモ機能**: 取引理由やメモの記録

### 3. ポジション管理機能
- **アクティブポジション表示**: 現在の未決済ポジション一覧
- **含み損益計算**: リアルタイム損益表示
- **決済機能**: 手動決済によるポジションクローズ

### 4. 履歴管理機能
- **取引履歴**: 完了した取引の記録
- **統計分析**: 勝率、損益、プロフィットファクター等
- **フィルター機能**: 通貨ペア、ステータス別フィルタリング

## 技術仕様

### フロントエンド
- **フレームワーク**: Next.js 15.1.6
- **UIライブラリ**: shadcn/ui
- **チャートライブラリ**: lightweight-charts 5.0.8
- **市場データ**: 改良されたサンプルデータ生成 + 外部API対応

### 市場データ管理
- **データソース**:
  - Yahoo Finance API (将来的)
  - Alpha Vantage API (将来的)
  - 改良されたサンプルデータ生成（現在）
- **データベース**: PostgreSQL (OHLCVDataモデル)
- **データ期間**: 2015年〜2025年（10年分）
- **対応時間足**: 1m, 5m, 15m, 30m, 1h, 4h, 1d
- **スタイリング**: Tailwind CSS

### バックエンド
- **データベース**: PostgreSQL (Prisma ORM)
- **認証**: Supabase Auth
- **API**: Next.js API Routes

### データベーススキーマ

```prisma
model PracticeTrade {
  id            String    @id @default(cuid())
  userId        String
  symbol        String    // 通貨ペア（例：USDJPY）
  timeframe     String    // 時間足（例：1m, 5m, 1h）
  entryTime     DateTime  // エントリー時間
  entryPrice    Float     // エントリー価格
  exitTime      DateTime? // エグジット時間
  exitPrice     Float?    // エグジット価格
  volume        Float     // ロット数
  tradeType     String    // トレードタイプ（BUY/SELL）
  profit        Float?    // 損益（自動計算）
  status        String    @default("OPEN") // OPEN/CLOSED
  memo          String?   @db.Text // メモ
  tags          String[]  // タグ配列
  stopLoss      Float?    // ストップロス価格
  takeProfit    Float?    // テイクプロフィット価格
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([symbol])
  @@index([entryTime])
  @@index([status])
  @@map("practice_trades")
}
```

## 画面構成

### 1. メイン練習画面 (`/practice`)

#### レイアウト
```
┌─────────────────────────────────────────────────────────┐
│                    FXトレード練習                        │
│  総損益: ¥XXX,XXX  取引回数: XX                          │
├─────────────────────────────────────────────────────────┤
│ チャート表示エリア (3/4幅) │ 取引パネル (1/4幅)          │
│ ┌─────────────────────┐ │ ┌─────────────────────────┐   │
│ │ チャート            │ │ │ 注文設定                │   │
│ │                     │ │ │ - ロット数              │   │
│ │                     │ │ │ - ストップロス          │   │
│ │                     │ │ │ - テイクプロフィット    │   │
│ │                     │ │ │ - メモ                  │   │
│ └─────────────────────┘ │ └─────────────────────────┘   │
│                         │ ┌─────────────────────────┐   │
│ チャートコントロール     │ │ アクティブポジション     │   │
│ - 通貨ペア選択          │ │ - ポジション一覧         │   │
│ - 時間足選択            │ │ - 含み損益表示          │   │
│ - 再生/停止/リセット    │ │ - 決済ボタン            │   │
│                         │ └─────────────────────────┘   │
│ トレードボタン          │                               │
│ [買い注文] [売り注文]   │                               │
└─────────────────────────────────────────────────────────┘
```

#### 機能詳細

**チャート表示エリア**
- リアルタイムローソク足チャート
- 現在価格の表示
- チャートの再生/停止/リセット機能
- 通貨ペア・時間足の切り替え

**取引パネル**
- ロット数設定（0.01〜10.00）
- ストップロス価格設定（オプション）
- テイクプロフィット価格設定（オプション）
- 取引メモ入力

**アクティブポジション**
- 未決済ポジションの一覧表示
- 各ポジションの含み損益表示
- 手動決済ボタン

### 2. 履歴画面 (`/practice/history`)

#### レイアウト
```
┌─────────────────────────────────────────────────────────┐
│                   トレード履歴                          │
│  [練習モードに戻る]                                     │
├─────────────────────────────────────────────────────────┤
│ 統計カード (4列)                                        │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │総取引数 │ │勝率     │ │総損益   │ │PF       │        │
│ │   XX    │ │  XX%    │ │ ¥XXX,XXX│ │  X.XX   │        │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
├─────────────────────────────────────────────────────────┤
│ フィルター                                              │
│ 通貨ペア: [全て ▼] ステータス: [全て ▼]                │
├─────────────────────────────────────────────────────────┤
│ 取引一覧 (2/3幅) │ 詳細表示 (1/3幅)                    │
│ ┌─────────────────┐ │ ┌─────────────────────────┐      │
│ │ 取引履歴        │ │ │ 取引詳細                │      │
│ │ - 買い USDJPY   │ │ │ - 通貨ペア・時間足       │      │
│ │ - 売り EURJPY   │ │ │ - エントリー価格        │      │
│ │ - 買い GBPUSD   │ │ │ - エグジット価格        │      │
│ │                 │ │ │ - ロット数              │      │
│ │                 │ │ │ - 損益                  │      │
│ │                 │ │ │ - メモ                  │      │
│ └─────────────────┘ │ └─────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
```

#### 機能詳細

**統計カード**
- 総取引数
- 勝率（勝ち取引数/総取引数）
- 総損益（純利益）
- プロフィットファクター（総利益/総損失）

**フィルター機能**
- 通貨ペア別フィルタリング
- ステータス別フィルタリング（オープン/クローズ）

**取引一覧**
- 取引の基本情報表示
- 損益の色分け表示（利益: 緑、損失: 赤）
- 取引選択による詳細表示

**詳細表示**
- 選択した取引の詳細情報
- メモの編集機能
- ストップロス・テイクプロフィット情報

## API仕様

### 1. 取引作成 API

**エンドポイント**: `POST /api/practice-trades`

**リクエスト例**:
```json
{
  "symbol": "USDJPY",
  "timeframe": "5m",
  "entryTime": 1640995200,
  "entryPrice": 150.123,
  "exitTime": 1640995500,
  "exitPrice": 150.456,
  "volume": 0.1,
  "tradeType": "buy",
  "profit": 3330,
  "memo": "トレンドフォロー戦略",
  "tags": ["トレンド", "USDJPY"],
  "stopLoss": 149.800,
  "takeProfit": 150.800
}
```

**レスポンス例**:
```json
{
  "success": true,
  "trade": {
    "id": "clx1234567890",
    "userId": "user123",
    "symbol": "USDJPY",
    "timeframe": "5m",
    "entryTime": "2024-01-01T00:00:00.000Z",
    "entryPrice": 150.123,
    "exitTime": "2024-01-01T00:05:00.000Z",
    "exitPrice": 150.456,
    "volume": 0.1,
    "tradeType": "buy",
    "profit": 3330,
    "status": "CLOSED",
    "memo": "トレンドフォロー戦略",
    "tags": ["トレンド", "USDJPY"],
    "stopLoss": 149.800,
    "takeProfit": 150.800,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 2. 取引履歴取得 API

**エンドポイント**: `GET /api/practice-trades`

**クエリパラメータ**:
- `page`: ページ番号（デフォルト: 1）
- `limit`: 1ページあたりの件数（デフォルト: 50）
- `symbol`: 通貨ペアフィルター
- `status`: ステータスフィルター（OPEN/CLOSED）

**レスポンス例**:
```json
{
  "trades": [
    {
      "id": "clx1234567890",
      "symbol": "USDJPY",
      "timeframe": "5m",
      "entryTime": "2024-01-01T00:00:00.000Z",
      "entryPrice": 150.123,
      "exitTime": "2024-01-01T00:05:00.000Z",
      "exitPrice": 150.456,
      "volume": 0.1,
      "tradeType": "buy",
      "profit": 3330,
      "status": "CLOSED",
      "memo": "トレンドフォロー戦略",
      "tags": ["トレンド", "USDJPY"],
      "stopLoss": 149.800,
      "takeProfit": 150.800
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 100,
    "totalPages": 2
  }
}
```

### 3. 取引更新 API

**エンドポイント**: `PATCH /api/practice-trades/[id]`

**リクエスト例**:
```json
{
  "memo": "更新されたメモ"
}
```

**レスポンス例**:
```json
{
  "success": true,
  "message": "Memo updated successfully"
}
```

## 損益計算ロジック

### 基本計算式
```
損益 = (エグジット価格 - エントリー価格) × ロット数 × 100,000 × 方向係数
```

### 方向係数
- **買いポジション**: 1
- **売りポジション**: -1

### 計算例
```
USDJPY 買いポジション
エントリー価格: 150.000
エグジット価格: 150.100
ロット数: 0.1

損益 = (150.100 - 150.000) × 0.1 × 100,000 × 1
     = 0.100 × 0.1 × 100,000
     = 1,000円
```

## エラー処理

### 1. データベースエラー
- **外部キー制約違反**: ユーザー認証エラー
- **バリデーションエラー**: 入力データの形式エラー
- **接続エラー**: データベース接続失敗

### 2. チャートエラー
- **lightweight-charts初期化エラー**: チャート表示失敗
- **データ形式エラー**: OHLCVデータの形式不正

### 3. ユーザー体験
- エラーメッセージの日本語表示
- 適切なフォールバック表示
- エラー発生時の再試行機能

## セキュリティ要件

### 1. 認証・認可
- Supabase Authによるユーザー認証
- ユーザー固有のデータアクセス制御
- APIエンドポイントの認証チェック

### 2. データ保護
- ユーザー間のデータ分離
- 機密情報の暗号化
- SQLインジェクション対策

### 3. 入力検証
- フロントエンド・バックエンド両方での入力検証
- XSS攻撃対策
- CSRF攻撃対策

## パフォーマンス要件

### 1. レスポンス時間
- ページ読み込み: 3秒以内
- API応答: 1秒以内
- チャート描画: 2秒以内

### 2. 同時接続数
- 最大100ユーザーの同時利用に対応

### 3. データ量
- 1ユーザーあたり最大10,000件の取引履歴
- チャートデータ: 最大1,000件のOHLCVデータ

## 📥 市場データインポート方法

### 1. Dukascopyからの実データインポート（推奨）

```bash
# 全通貨ペア・全時間足のDukascopyデータを一括インポート（2015-2024年）
npm run import-dukascopy-all

# 特定の通貨ペアのDukascopyデータをインポート
npm run import-dukascopy -- --symbol USDJPY --timeframe 1d --from 2020-01-01 --to 2024-01-01

# EURUSD 1時間足 2023年のデータをインポート
npm run import-dukascopy -- --symbol EURUSD --timeframe 1h --from 2023-01-01 --to 2023-12-31
```

### 2. サンプルデータによるインポート（開発・テスト用）

```bash
# 全通貨ペア・全時間足のサンプルデータを一括インポート（2015-2025年）
npm run import-all-data

# 特定の通貨ペアのサンプルデータをインポート
npm run import-data -- --symbol USDJPY --timeframe 1d --period 10y

# 詳細なオプション指定
npm run import-data -- --symbol EURUSD --timeframe 1h --period 5y --start-date 2020-01-01
```

## 📊 Dukascopyデータソースについて

### Dukascopyとは
- スイスの外国為替ブローカー
- 高品質な市場データを無料で提供
- ティック単位から日足まで幅広い時間足に対応
- 2009年以降の豊富な履歴データ

### 利用可能なデータ
- **通貨ペア**: USDJPY, EURJPY, GBPJPY, EURUSD, GBPUSD
- **時間足**: 1分, 5分, 15分, 30分, 1時間, 4時間, 1日
- **データ期間**: 2009年〜現在
- **データ品質**: 実際の市場データ（スプレッド、ギャップ含む）

### データ品質の特徴
- 実際の市場価格を反映
- 週末のギャップや市場休場時間を含む
- スプレッドや流動性の変動を含む
- 重要経済指標発表時の値動きを含む

### Dukascopyインポートコマンド詳細

```bash
# ヘルプ表示
npm run import-dukascopy -- --help

# 特定通貨ペア・時間足の指定期間インポート
npm run import-dukascopy -- --symbol USDJPY --timeframe 1d --from 2020-01-01 --to 2024-01-01

# 短期間の高頻度データ（1分足）
npm run import-dukascopy -- --symbol EURUSD --timeframe 1m --from 2024-01-01 --to 2024-01-31

# 全通貨ペア一括インポート（推奨: 主要時間足のみ）
npm run import-dukascopy-all
```

### 2. インポート可能なデータ

**対応通貨ペア**:
- USDJPY (ドル円): 基準価格 150.0円
- EURJPY (ユーロ円): 基準価格 160.0円
- GBPJPY (ポンド円): 基準価格 190.0円
- EURUSD (ユーロドル): 基準価格 1.08ドル
- GBPUSD (ポンドドル): 基準価格 1.27ドル

**対応時間足**:
- 1m: 1分足（超短期スキャルピング）
- 5m: 5分足（短期デイトレード）
- 15m: 15分足（デイトレード）
- 30m: 30分足（デイトレード）
- 1h: 1時間足（スイングトレード）
- 4h: 4時間足（スイングトレード）
- 1d: 日足（長期トレード）

### 3. データ特徴

**改良されたサンプルデータ**:
- 通貨ペア固有の適切な価格帯
- 現実的なボラティリティ設定
- JPY系通貨ペアは3桁小数、USD系は5桁小数
- 時間足に応じた適切な値動き幅

### 4. スクリプト実行例

```bash
# ヘルプ表示
npm run import-data -- --help

# USDJPY 1日足 10年分をインポート
npm run import-data -- --symbol USDJPY --timeframe 1d --period 10y

# EURUSD 1時間足 5年分を2020年から開始
npm run import-data -- --symbol EURUSD --timeframe 1h --period 5y --start-date 2020-01-01

# 全通貨ペアを一括インポート（10年分）
npm run import-all-data
```

## 🚀 今後の拡張予定

### 1. 機能拡張
- リアルタイム市場データ連携（Yahoo Finance/Alpha Vantage）
- テクニカル指標の追加
- バックテスト機能
- 取引戦略の自動実行

### 2. 分析機能
- 詳細なパフォーマンス分析
- リスク分析
- ポートフォリオ分析
- 取引パターン分析

### 3. コミュニティ機能
- 取引記録の共有
- ユーザー間のランキング
- 取引戦略の共有
- メンタリング機能

## 運用・保守

### 1. 監視項目
- API応答時間
- エラー発生率
- データベース接続状況
- ユーザーアクティビティ

### 2. バックアップ
- データベースの定期バックアップ
- ログファイルの保存
- 設定ファイルのバージョン管理

### 3. 更新・メンテナンス
- 定期的なセキュリティアップデート
- パフォーマンス最適化
- 新機能の段階的リリース

## 注意事項

### 1. 利用制限
- 練習取引のため、実際の資金は発生しません
- チャートデータはサンプルデータです
- 実際の市場とは異なる動きをする場合があります

### 2. 技術的制約
- lightweight-charts v5のAPI変更に注意
- ブラウザの互換性確認が必要
- モバイルデバイスでの表示最適化

### 3. データ管理
- 古い取引データの自動アーカイブ
- ユーザー削除時のデータ完全削除
- プライバシーポリシーの遵守
